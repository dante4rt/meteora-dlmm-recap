---
import '../styles/spectrum.css';

interface Props {
  title: string;
  headings?: Array<{ depth: number; slug: string; text: string }>;
}

const { title, headings = [] } = Astro.props;
const navHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);
---

<!doctype html>
<html lang="en" class="spectrum spectrum--medium spectrum--light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | Meteora DLMM Recap</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body class="spectrum-Body">
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
      Light
    </button>

    <div class="docs-wrapper">
      <aside class="docs-sidebar">
        <div class="docs-sidebar-title">On This Page</div>
        <nav>
          {navHeadings.map((h) => (
            <a href={`#${h.slug}`} class={h.depth === 3 ? 'depth-3' : ''}>
              {h.text}
            </a>
          ))}
        </nav>
      </aside>

      <main class="docs-content">
        <slot />
      </main>
    </div>

    <script is:inline src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <script is:inline>
      (function () {
        var root = document.documentElement;
        var btn = document.getElementById('theme-toggle');
        var stored = localStorage.getItem('theme');
        var isDark = stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches);

        if (isDark) {
          root.classList.replace('spectrum--light', 'spectrum--darkest');
          btn.textContent = 'Dark';
        }

        function getMermaidTheme() {
          return root.classList.contains('spectrum--darkest') ? 'dark' : 'default';
        }

        function initMermaid() {
          mermaid.initialize({
            startOnLoad: false,
            theme: getMermaidTheme(),
            fontFamily: 'inherit',
            flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' },
          });

          var blocks = document.querySelectorAll('pre[data-language="mermaid"]');
          blocks.forEach(function (pre) {
            var raw = pre.textContent;
            var container = document.createElement('div');
            container.className = 'mermaid';
            container.setAttribute('data-mermaid-src', raw);
            container.textContent = raw;
            pre.replaceWith(container);
          });

          mermaid.run({ querySelector: '.mermaid' });
        }

        function reRenderMermaid() {
          var containers = document.querySelectorAll('.mermaid');
          containers.forEach(function (el) {
            var src = el.getAttribute('data-mermaid-src');
            if (src) {
              el.removeAttribute('data-processed');
              el.innerHTML = src;
            }
          });
          mermaid.initialize({ theme: getMermaidTheme(), fontFamily: 'inherit', flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' } });
          mermaid.run({ querySelector: '.mermaid' });
        }

        btn.addEventListener('click', function () {
          var dark = root.classList.contains('spectrum--darkest');
          if (dark) {
            root.classList.replace('spectrum--darkest', 'spectrum--light');
            btn.textContent = 'Light';
            localStorage.setItem('theme', 'light');
          } else {
            root.classList.replace('spectrum--light', 'spectrum--darkest');
            btn.textContent = 'Dark';
            localStorage.setItem('theme', 'dark');
          }
          reRenderMermaid();
        });

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initMermaid);
        } else {
          initMermaid();
        }
      })();
    </script>
  </body>
</html>
