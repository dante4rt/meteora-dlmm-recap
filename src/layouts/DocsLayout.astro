---
import '../styles/spectrum.css';
import { getTranslations, type Locale } from '../i18n/utils';
import LanguageSwitcher from '../components/LanguageSwitcher.astro';

interface Props {
  title: string;
  locale: Locale;
  headings?: Array<{ depth: number; slug: string; text: string }>;
}

const { title, locale, headings = [] } = Astro.props;
const t = getTranslations(locale);
const navHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);
const currentPath = Astro.url.pathname;
// For new routing: English has no prefix, Indonesian has /id/
const pathWithoutLocale = locale === 'id' ? currentPath.replace(/^\/id/, '') : currentPath;
const siteUrl = 'https://meteora-dlmm-recap.pages.dev';
---

<!doctype html>
<html lang={locale} class="spectrum spectrum--medium spectrum--light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | {t.site.title}</title>
    <meta name="description" content={t.site.description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    
    <!-- Language alternates for SEO -->
    <link rel="alternate" hreflang="en" href={`${siteUrl}${pathWithoutLocale}`} />
    <link rel="alternate" hreflang="id" href={`${siteUrl}/id${pathWithoutLocale}`} />
    <link rel="alternate" hreflang="x-default" href={`${siteUrl}${pathWithoutLocale}`} />
  </head>
  <body class="spectrum-Body">
    <div class="header-controls">
      <LanguageSwitcher locale={locale} currentPath={currentPath} />
      <button class="theme-toggle" id="theme-toggle" aria-label={t.nav.toggleTheme}>
        {t.theme.light}
      </button>
    </div>

    <div class="docs-wrapper">
      {navHeadings.length > 0 && (
      <aside class="docs-sidebar" id="docs-sidebar">
        <button class="docs-sidebar-toggle" id="sidebar-toggle" aria-label={t.nav.toggleSidebar} aria-expanded="false">
          <span class="docs-sidebar-title">{t.sidebar.title}</span>
          <svg class="toggle-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <nav class="docs-sidebar-nav">
          {navHeadings.map((h) => (
            <a href={`#${h.slug}`} class={h.depth === 3 ? 'depth-3' : ''}>
              {h.text}
            </a>
          ))}
        </nav>
      </aside>
      )}

      <main class="docs-content">
        <slot />
      </main>
    </div>

    <script is:inline src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <script is:inline define:vars={{ lightText: t.theme.light, darkText: t.theme.dark }}>
      (function () {
        var root = document.documentElement;
        var btn = document.getElementById('theme-toggle');
        var stored = localStorage.getItem('theme');
        var isDark = stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches);

        if (isDark) {
          root.classList.replace('spectrum--light', 'spectrum--darkest');
          btn.textContent = darkText;
        }

        function getMermaidTheme() {
          return root.classList.contains('spectrum--darkest') ? 'dark' : 'default';
        }

        function initMermaid() {
          mermaid.initialize({
            startOnLoad: false,
            theme: getMermaidTheme(),
            fontFamily: 'inherit',
            flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' },
          });

          var blocks = document.querySelectorAll('pre[data-language="mermaid"]');
          blocks.forEach(function (pre) {
            var raw = pre.textContent;
            var container = document.createElement('div');
            container.className = 'mermaid';
            container.setAttribute('data-mermaid-src', raw);
            container.textContent = raw;
            pre.replaceWith(container);
          });

          mermaid.run({ querySelector: '.mermaid' });
        }

        function reRenderMermaid() {
          var containers = document.querySelectorAll('.mermaid');
          containers.forEach(function (el) {
            var src = el.getAttribute('data-mermaid-src');
            if (src) {
              el.removeAttribute('data-processed');
              el.innerHTML = src;
            }
          });
          mermaid.initialize({ theme: getMermaidTheme(), fontFamily: 'inherit', flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' } });
          mermaid.run({ querySelector: '.mermaid' });
        }

        btn.addEventListener('click', function () {
          var dark = root.classList.contains('spectrum--darkest');
          if (dark) {
            root.classList.replace('spectrum--darkest', 'spectrum--light');
            btn.textContent = lightText;
            localStorage.setItem('theme', 'light');
          } else {
            root.classList.replace('spectrum--light', 'spectrum--darkest');
            btn.textContent = darkText;
            localStorage.setItem('theme', 'dark');
          }
          reRenderMermaid();
        });

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initMermaid);
        } else {
          initMermaid();
        }

        // Sidebar toggle for mobile
        var sidebarToggle = document.getElementById('sidebar-toggle');
        var sidebar = document.getElementById('docs-sidebar');
        
        if (sidebarToggle && sidebar) {
          sidebarToggle.addEventListener('click', function () {
            var isExpanded = sidebar.classList.toggle('expanded');
            sidebarToggle.setAttribute('aria-expanded', isExpanded);
          });

          // Auto-collapse on mobile when clicking a nav link
          var navLinks = sidebar.querySelectorAll('.docs-sidebar-nav a');
          navLinks.forEach(function(link) {
            link.addEventListener('click', function() {
              if (window.innerWidth < 768) {
                sidebar.classList.remove('expanded');
                sidebarToggle.setAttribute('aria-expanded', 'false');
              }
            });
          });
        }
      })();
    </script>
  </body>
</html>
